# ELB: Elastic Load Balancers

Load balancers are servers that forward internet traffic to multiple servers (EC2 Instances) downstream

#### Why use a load balancer?
* Spread load across multiple downstream instances
* Expose a single point of access (DNS) to your application
* Seamlessly handle failures of downstream instances
* Do regular health checks to your instances
* Provide SSL termination (HTTPS) for your websites
* Enforce stickiness with cookies
* High availability across zones
* Separate public traffic from private traffic

#### AN ELB (EC2 Load Balancer) is a managed load balancer
* AWS guarantees that it will be working
* AWS takes care of upgrades, maintenance, high availability
* AWS provides only a few configuration knobs

It costs less to setup your own load balancer, but it will be a lot more effort on your end.   
It is integrated with many AWS offerings / services

#### Health Checks
* Health checks are crucial for load balancers
* They enable the load balancer to know if instances it forwards traffic to are available to reply to requests
* The health check is done on a port and a route (/health is common)
* If the response is not 200 (OK), then the instance is unhealthy

#### Types of load balancers on AWS
* Classic Load Balancer (v1 - older generation - 2009) - Not reccomended 
* Application Load Balancer (v2 - new generation - 2016)
* Network Load Balancer (v2 - new generation - 2017)
* Gateway Load Balancer (2020)
* You can setup internal or external ELBs

#### Application Load Balancer (v2)
* Application load balancers (Layer 7) allow to do:
  * Load balancing to multiple HTTP applications across machines (target groups)
  * Load balancing to multiple applications on the same machine (ex: containers)
  * Load balancing and routing based on route in URL
  * Load balancing and routing based on hostname in URL 
  * Routing based on query strings and headers
  * Supports redirects(for eg.- from HTTP to HTTPS)
  * Can route to multiple target groups (eg.- EC2, ECS, Lambda functions)
  * Health checks are done at the target group level
* Basically, they’re awesome for micro services & container-based application (example: Docker & Amazon ECS) 
* Has a port mapping feature to redirect to a dynamic port 
* In comparison, we would need to create one Classic Load Balancer per application before.That was very expensive and inefficient!
* Good to Know
    * ALB supports HTTP/HTTPS & Web sockets protocols
    * The application servers don’t see the IP of the client directly
        * The true IP of the client is inserted in the header called X-Forwarded-For
        * We can also get Port (X-Forwarded-Port) and protocol (X-Forwarded-Proto)
    * Cross-Zone load balancing is enabled by default and incur no charges for inter AZ data
#### Network Load Balancer (v2)
* Layer 4 allow you to do:
    * Forward TCP/UDP traffic to your instances
    * Handle millions of requests per second
    * Support for static IP or elastic IP
    * Less latency ~100ms (vs 400 ms for ALB)
    * One static IP per AZ and supports assigning Elastic IP
    * Health check support TCP, HTTP and HTTPS protocols
    * Can be combined with ALB to get the rules for handling HTTP traffic
* Network Load Balancers are mostly used for extreme performance and should not be the default load balancer you choose
* Cross-Zone load balancing is disabled by default and you are charged for inter-AZ data
* Overall, the creation process is the same as the Application Load Balancer
#### Gateway Load Balancer
* Layer 3 (Network Layer) - IP Packets
* Sometimes you might want to use 3rd party network virtual appliances (eg- firewalls, Intrusion detection and prevention systems, Deep packet Inspection systems, payload manipulation, etc.).
* Gateway Load balancer allows you to deploy, scale and manage a fleet of these 3rd party network appliances
* Cross-Zone load balancing is disabled by default and you are charged for inter-AZ data
* How it works -
    * It will first route the traffic to target groups comprising of your 3rd security appliances
    * If the traffic is accepted by the security appliances they then send it back to the load balancer
    * The load balancer will then route this accepted traffic to the right applications (eg.- EC2 instances)
    * If the traffic is not accepted then it is just dropped
* Combines the following functions- 
    * **Transparent Network gateway**: single entry/exit point
    * **Load Balancer**: distribute traffic to your virtual appliances
**Uses the GENEVE protocol on port 6081**

#### Sticky Sessions
* Same request (or client) goes to the same instance
* Can be implemented by Application Load Balancer, Classic Load Balancer and Network Load Balancer
* Uses cookies (except NLB)
* Enabling stickiness may imbalance the load over the EC2 instances
* **Cookie names**
    * **Application based cookie** 
    * Custom cookie 
        * Generated by the target
        * Can include any custom attributes
        * Cookie name must be specified for each individual group
    * Application cookie
        * Generated by load balancer
        * Cookie name - AWSALBAPP
    * **Duration Based cookie**
        * Cookie generated by load balancer
        * Cookie name is AWSALB for ALB, AWSELB for CLB

#### Cross-Zone Load Balancing
* Cross-zone load balancing is an AWS feature that allows an Elastic Load Balancer (ELB) to distribute traffic evenly across all registered instances, regardless of the Availability Zone (AZ) they are in.
![alt text](/images/image-3.png)

#### SSL/TLS Certificates
* They allow traffic between the client and your load balancer to be encrypted in transit(in-flight encryption)
* SSL - Secure Socket Layer, TLS - Transport Layer Security
* Have an expiration date(set by you) and must be renewed
* Certificates are managed by ACM (AWS Certificate Manager)
* The load balancer uses X.509 certificate
* You can create and upload your own certificates alternatively
* If you set an HTTPS listener
    * You must specify a default certificate
    * you can add an optional list of certs to support multiple domains
    * Clients can SNI (Server Name Indication) to specify the hostname they reach
    * you have the ability to specify a security policy to support older versions of SSL/TLS
**SNI**
* Solves the problem of loading multiple certs onto one web server(to serve multiple websites)
* It is a newer protocol and requires client to indicate hostname of target server in the initial SSL handshake
* The server will then find the correct cert or return the default one
* Only works for ALB, NLB and CloudFront. Does not work for CLB

#### Connection Draining / Deregistration Delay
* Time to complete "in-flight requests" when the instance is de-registering or unhealthy
* Stops sending new request to that instance
* Between 1 to 3600s(default 300s)
* Can be disabled(set to 0)
* Connection Draining - CLB
* Deregistering delay - ALB, NLB

#### Load Balancers Good to Know
* Any Load Balancer (CLB, ALB, NLB) has a static host name. They do not resolve and use underlying IP
* LBs can scale but not instantaneously - contact AWS for a “warm up”
* NLB directly sees the client IP
* 4xx errors are client induced errors
* 5xx errors are application induced errors
    * Load balancer Errors 503 means at capacity or no registered target
* If the LB can’t connect to your application, check your security